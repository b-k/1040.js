
<meta charset="utf-8">
<!-- Licensed under GPLv2, with one clarification; see https://github.com/b-k/1040.js . -->
<html>
<title>The tax graph</title>

<script src="d3.v3.min.js" charset="utf-8"></script>
<script src="dagre-d3.min.js" charset="utf-8"></script>
<script>

</script>

<style id="css">
g.u > rect {
  fill: #caf2bd;
}

text {
  font-weight: 300;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;
  font-size: 19px;
}

input[type=checkbox]
{
   padding: 10px;
}

.checkboxtext
{
    /* Checkbox text */
    font-size: 110%;
    display: inline;
}


body{
  font-size: 25px;
}

.node rect {
  stroke: #999;
  fill: #fff;
  stroke-width: 1.5px;
}

.edgePath path {
  stroke: #333;
  stroke-width: 1.5px;
}


div.tooltip { /* thx, http://www.d3noob.org/2013/01/adding-tooltips-to-d3js-graph.html */
  position: absolute;
  text-align: center;
  /*width: 60px;
  height: 28px;                 */
  padding: 3px;
  font: 25px sans-serif;
  background: lightsteelblue;
  border: 1px;
  border-radius: 8px;
  pointer-events: none;
}

</style>

<body>
The 2018 U.S. tax graph<br>
Click an avocado box to enter a value.<br>
To see more or less, use your browser's zoom (often &lt;ctrl&gt;-&lt;+&gt; or &lt;ctrl&gt;-&lt;-&gt;, or try your mouse wheel).<br>

<table><tr><td>
<input type="radio" name="spouse" size=3em checked onchange="recalc()"> I am single.<br>
<input type="radio" name="spouse" size=3em onchange="recalc()"> I have a spouse; we file jointly.<br>
<input type="radio" name="spouse" size=3em onchange="recalc()"> I have a spouse; we file separately.<br>
<input text id="kids" size=3em onchange="kidcalc()"> Dependent children<br>
<input text id="nonkid_dependents" size=3em onchange="recalc()"> Dependents over 17<br>
</td><td>


<INPUT class=check TYPE=CHECKBOX NAME="over_65" id=".over_65" onclick="checkbox(id, checked)" checked><span class="checkboxtext"> I am over 65.</span><BR>

<INPUT class=check TYPE=CHECKBOX NAME="spouse_over_65" id=".spouse_over_65" onclick="checkbox(id, checked)" checked><span class="checkboxtext"> My spouse is over 65.</span><BR>
<INPUT class=check TYPE=CHECKBOX NAME="s_loans" id=".s_loans" onclick="checkbox(id, checked)" checked><span class="checkboxtext"> I have student loans or education expenses.</span><BR>
<INPUT class=check TYPE=CHECKBOX NAME="mort" id=".mort" onclick="checkbox(id, checked)" checked><span class="checkboxtext"> I have a mortgage.</span><BR>
<INPUT class=check TYPE=CHECKBOX NAME="itemizing" id=".itemizing" onclick="checkbox(id, checked)" checked><span class="checkboxtext"> I am itemizing.</span><BR>
<INPUT class=check TYPE=CHECKBOX NAME="have_rr" id=".have_rr" onclick="checkbox(id, checked)" checked><span class="checkboxtext"> I have rental or royalty income.</span><BR>
<INPUT class=check TYPE=CHECKBOX NAME="hide_zeros" id=".hide_zeros" onclick="hidezeros(id, checked)" ><span class="checkboxtext"> I want to hide the inessential zero cells.</span><BR>
<a href="https://github.com/b-k/1040.js">I want to make this tax explorer better.</a>
</td></tr></table>

<svg id="svg-canvas" width=960 height=600></svg>

<script id="js">
<!-- Much of this started at http://cpettitt.github.io/project/dagre-d3/latest/demo/sentence-tokenization.html -->

var itemizing = 0;
var over_65 = 0;
var spouse_over_65 = 0;


//2018 tax rate schedules
//Could be inlined, but not going to bother.
// https://www.irs.gov/pub/irs-prior/f1040es--2018.pdf
var tax_table = function (inval){
    var filing_status = fstatus();
    if (filing_status == "single") {
        if (inval < 9525) return inval * 0.1;
        if (inval < 38700) return    952.50 + 0.12 * (inval - 9525);
        if (inval < 82500) return   4453.50 + 0.22 * (inval - 38700);
        if (inval < 157500) return 14089.50 + 0.24 * (inval - 82500);
        if (inval < 200000) return 32089.50 + 0.32 * (inval - 157500);
        if (inval < 500000) return 45689.50 + 0.35 * (inval - 200000);
        return 150689.50 + 0.37 * (inval - 500000);
    } else if (filing_status == "married filing jointly") {
        if (inval < 19050) return inval * 0.1;
        if (inval < 77400) return 1905 + 0.12 * (inval - 19050);
        if (inval < 165000) return 8907 + 0.22 * (inval - 77400);
        if (fnval < 315000) return 28179 + 0.24 * (inval - 165000);
        if (inval < 400000) return 64179 + 0.32 * (inval - 315000);
        if (inval < 600000) return 91379 + 0.35 * (inval - 400000);
        return 161379 + 0.37 * (inval - 600000);
    } else if (filing_status == "married") {
        if (inval < 9525) return inval * 0.1;
        if (inval < 38700) return 952.50 + 0.12 * (inval - 9525);
        if (inval < 82500) return 4453.50 + 0.22 * (inval - 38700);
        if (inval < 157500) return 14089.50 + 0.24 * (inval - 82500);
        if (inval < 200000) return 32089.50 + 0.32 * (inval - 157500);
        if (inval < 300000) return 45689.50 + 0.35 * (inval - 200000);
        return 80689.50 + 0.37 * (inval - 300000);
    } else if (filing_status == "head of household") {
        if (inval < 13600) return inval * 0.1;
        if (inval < 51800) return 1360 + 0.12 * (inval - 13600);
        if (inval < 82500) return 5944 + 0.22 * (inval - 51800);
        if (inval < 157500) return 12698 + 0.24 * (inval - 82500);
        if (inval < 200000) return 30698 + 0.32 * (inval - 157500);
        if (inval < 500000) return 44298 + 0.35 * (inval - 200000);
        return 149298 + 0.37 * (inval - 500000);
    }
}

//The tax tables break income into $50 ranges, then uses the midpoint.
var tax_calc = function (inval){
    if (inval==0) return 0;
    if (inval >=100000) return tax_table(inval)
    return tax_table(Math.round(inval/50)*50 + 25)
}

var eitc = function(income, k){
    if (fstatus()=="married") return 0
    var kids = parseFloat(document.getElementById("kids").value)
    if (isNaN(kids)) kids = 0;
    //See http://www.taxpolicycenter.org/taxfacts/displayafact.cfm?Docid=36
    //and irs.gov/irb/2018-10_IRB#RP-2018-18
    //plateu start, plateu value, plateu end, zero point, end for married joint, zero for mj
    data=[[6780, 519, 8490, 15270, 14170, 20950],
          [10180, 3461,  18660, 40320, 24350, 46010],
          [14290, 5716, 18660, 45802, 24350, 51492],
          [14290, 6431, 18660, 49194, 24350, 54884]]
     row = Math.min(kids,3);

    plateu_start=0
    plateu_value=1

    if (fstatus()=="married filing jointly"){
        phaseout_start=4;
        phaseout_end=5;
    } else {
        phaseout_start=2;
        phaseout_end=3;
    }
    
    if (income >= data[row][phaseout_end]) return 0;
    if (income >= data[row][phaseout_start])
        return Math.round(100*data[row][plateu_value]*(1-(income-data[row][phaseout_start])
                                            /(data[row][phaseout_end]-data[row][phaseout_start])))/100
    if (income <= data[row][plateu_start])
        return Math.round(income*data[row][plateu_value]/data[row][plateu_start])/100;
    return data[row][plateu_value];
}

var actc = function(limited_unused, scaled_income, ss_med, eitc){
    var kids = parseFloat(document.getElementById("kids").value)
    if (isNaN(kids)) kids = 0;

    if (kids >=3){
        if (scaled_income==0) return 0;
        else return min(limited_unused, scaled_income);
    }

    //Did you have a lot of soc sec/Medicare withheld, and EITC still isn't covering it?
    //We'll up the credit to cover that if it's more than your scaled income.
    if (limited_unused <= scaled_income)
        return min(limited_unused, scaled_income);
    else
        return min(max(ss_med-eitc, scaled_income), limited_unused);
}


var fstatus = function(){
    var kids = parseFloat(document.getElementById("kids").value)
    if (isNaN(kids)) kids = 0;
    var deps = parseFloat(document.getElementById("nonkid_dependents").value)
    if (isNaN(deps)) deps = 0;
    var single = document.getElementsByName("spouse")[0].checked;
    if (single && kids+deps) return "head of household";
    if (single && !(kids+deps)) return "single";
    if (document.getElementsByName("spouse")[1].checked) return "married filing jointly";
    else return "married";
}

var max = function(a,b) { return Math.max(a,b)}
var min = function(a,b) { return Math.min(a,b)}
var Floor = function(a) { return Math.floor(a)}
var Ceil = function(a) { return Math.ceil(a)}

var exemption_fn = function(){
    var ct = 1
    var kids = parseFloat(document.getElementById("kids").value)
    if (isNaN(kids)) kids = 0;
    var deps = parseFloat(document.getElementById("nonkid_dependents").value)
    if (isNaN(deps)) deps = 0;
    ct += kids + deps
    var status = fstatus()
    if (status=="married" || status == "married filing jointly") ct += 1
    return ct;
}

//CTC
var thousandkids = function(){
    var kids = parseFloat(document.getElementById("kids").value)
    if (isNaN(kids)) kids = 0;
    var deps = parseFloat(document.getElementById("nonkid_dependents").value)
    if (isNaN(deps)) deps = 0;
    return kids*2000 + deps*500
}

var fourteenkids = function(){
    var kids = parseFloat(document.getElementById("kids").value)
    if (isNaN(kids)) kids = 0;
    return kids*1400
}

var ctc_status = function(agi){
    var ded=0;
    var status = fstatus();
    if (status=="married filing jointly") ded=400000;
    else ded=200000;
    diff = max(agi-ded, 0)
    return Math.ceil(diff/1000.)*1000*0.05
}




function get_amt_exemption(income){
    var status=fstatus();
    var s_or_hh = (status=="single" || status=="head of household")
    var mfj = (status=="married filing jointly")
    if (s_or_hh && income) return 70300
    if (mfj && income) return 109400
    if (status=="married") return 54700

    return 0
    //No longer calculating phase-out
}


function get_tamt(income){
    if (income<=0) return 0
    var status=fstatus();
    return (status=="married")
       ? income * (income <=95550 ? .26 : .28) - 1911
       : income * (income <=191100? .26 : .28) - 3822;
}

function med_expenses(expenses, agi){
    var over_65 = situations[".over_65"] ||situations[".spouse_over_65"]

    if (!over_65) return 0
    return Math.max(Math.min(expenses, .025*agi), 0)
}




// Create the input graph
var g = new dagreD3.graphlib.Graph()
  .setGraph({})
  .setDefaultEdgeLabel(function() { return {}; });


g.setNode("f1040sch1_taxable_tax_refunds",  { label: "taxable_tax_refunds", baselabel: "taxable_tax_refunds", form: "f1040sch1", fullname: "Taxable state/local income tax refunds/credits/offsets", class: "a_node ", val:0 , eqn: "Cv('f1040_tax_refund_ws_taxable_refund')", last_eval:0 });
g.setNode("f1040sch1_alimony",  { label: "alimony", baselabel: "alimony", form: "f1040sch1", fullname: "Alimony income received", class: "a_node u", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040sch1_sched_c",  { label: "sched_c", baselabel: "sched_c", form: "f1040sch1", fullname: "Schedule C business income (UI)", class: "a_node u", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040sch1_cap_gains",  { label: "cap_gains", baselabel: "cap_gains", form: "f1040sch1", fullname: "Capital gains", class: "a_node u", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040sch1_rr_income",  { label: "rr_income", baselabel: "rr_income", form: "f1040sch1", fullname: "Rents and royalties from Schedule E", class: "a_node have_rr", val:0 , eqn: "Cv('f1040_sched_e_rr_income')", last_eval:0 });
g.setNode("f1040sch1_farm_income",  { label: "farm_income", baselabel: "farm_income", form: "f1040sch1", fullname: "Farm income from Schedule F (UI)", class: "a_node u", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040sch1_unemployment",  { label: "unemployment", baselabel: "unemployment", form: "f1040sch1", fullname: "Unemployment compensation", class: "a_node u", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040sch1_other_in",  { label: "other_in", baselabel: "other_in", form: "f1040sch1", fullname: "Other income.", class: "a_node u", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040sch1_sch1_magi_subtotal",  { label: "sch1_magi_subtotal", baselabel: "sch1_magi_subtotal", form: "f1040sch1", fullname: "Schedule 1 subtotal", class: "a_node ", val:0 , eqn: "Cv('f1040sch1_taxable_tax_refunds') + Cv('f1040sch1_alimony') + Cv('f1040sch1_sched_c') + Cv('f1040sch1_cap_gains') + Cv('f1040sch1_farm_income') + Cv('f1040sch1_unemployment') + Cv('f1040sch1_other_in') + 0", last_eval:0 });
g.setNode("f1040sch1_ira_deduction",  { label: "ira_deduction", baselabel: "ira_deduction", form: "f1040sch1", fullname: "IRA deduction", class: "a_node u", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040sch1_student_loan_interest_ded",  { label: "student_loan_interest_ded", baselabel: "student_loan_interest_ded", form: "f1040sch1", fullname: "Student loan interest deduction ", class: "a_node s_loans", val:0 , eqn: "Cv('student_loan_ws_1040_final_credit')", last_eval:0 });
g.setNode("f1040sch1_subtractions_from_income",  { label: "subtractions_from_income", baselabel: "subtractions_from_income", form: "f1040sch1", fullname: "Sum of subtractions from gross income (UI)", class: "a_node ", val:0 , eqn: "Cv('f1040sch1_ira_deduction') + Cv('f1040sch1_student_loan_interest_ded') + 0", last_eval:0 });
g.setNode("f1040_wages",  { label: "wages", baselabel: "wages", form: "f1040", fullname: "Wages, salaries, tips, from form W-2", class: "a_node u", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_interest",  { label: "interest", baselabel: "interest", form: "f1040", fullname: "Taxable interest", class: "a_node u", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_dividends",  { label: "dividends", baselabel: "dividends", form: "f1040", fullname: "Ordinary dividends", class: "a_node u", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_iras_pensions",  { label: "iras_pensions", baselabel: "iras_pensions", form: "f1040", fullname: "Taxable IRA distributions", class: "a_node u", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_taxable_ss_benefits",  { label: "taxable_ss_benefits", baselabel: "taxable_ss_benefits", form: "f1040", fullname: "Taxable social security benefits", class: "a_node u over_65 spouse_over_65", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_MAGI",  { label: "MAGI", baselabel: "MAGI", form: "f1040", fullname: "Total income for MAGI (PI)", class: "a_node ", val:0 , eqn: "Cv('f1040sch1_sch1_magi_subtotal') + Cv('f1040_wages') + Cv('f1040_interest') + Cv('f1040_dividends') + Cv('f1040_iras_pensions') + Cv('f1040_taxable_ss_benefits') + 0", last_eval:0 });
g.setNode("f1040_total_in",  { label: "total_in", baselabel: "total_in", form: "f1040", fullname: "Total income", class: "a_node ", val:0 , eqn: "Cv('f1040_MAGI') + Cv('f1040sch1_rr_income')", last_eval:0 });
g.setNode("f1040_AGI",  { label: "AGI", baselabel: "AGI", form: "f1040", fullname: "Adjusted gross income", class: "a_node critical", val:0 , eqn: "max(Cv('f1040_total_in') - Cv('f1040sch1_subtractions_from_income'),0)", last_eval:0 });
g.setNode("f1040_std_deduction",  { label: "std_deduction", baselabel: "std_deduction", form: "f1040", fullname: "Standard deductions", class: "a_node ", val:0 , eqn: "((fstatus()=='married') ? (12000) : (((fstatus()=='single') ? (12000) : (((fstatus()=='married filing jointly') ? (24000) : (((fstatus()=='head of household') ? (18000) : (0 )) )) )) )) ", last_eval:0 });
g.setNode("f1040_deductions",  { label: "deductions", baselabel: "deductions", form: "f1040", fullname: "Deductions", class: "a_node critical", val:0 , eqn: "max(Cv('f1040_std_deduction'), Cv('f1040_sched_a_total_itemized_deductions'))", last_eval:0 });
g.setNode("f1040_qbi",  { label: "qbi", baselabel: "qbi", form: "f1040", fullname: "Qualified business income", class: "a_node u", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_taxable_income",  { label: "taxable_income", baselabel: "taxable_income", form: "f1040", fullname: "Taxable income", class: "a_node critical", val:0 , eqn: "max(Cv('f1040_AGI') - Cv('f1040_deductions') - Cv('f1040_qbi'), 0)", last_eval:0 });
g.setNode("f1040_tax",  { label: "tax", baselabel: "tax", form: "f1040", fullname: "Tax", class: "a_node critical", val:0 , eqn: "tax_calc(Cv('f1040_taxable_income'))", last_eval:0 });
g.setNode("f1040_other_taxes",  { label: "other_taxes", baselabel: "other_taxes", form: "f1040", fullname: "Sched 2, AMT + F8962", class: "a_node ", val:0 , eqn: "Cv('f1040sch2_amt') + Cv('f1040sch2_credit_repayment')", last_eval:0 });
g.setNode("f1040_pretotal_tax",  { label: "pretotal_tax", baselabel: "pretotal_tax", form: "f1040", fullname: "Tax + Sched 2, AMT + F8962", class: "a_node ", val:0 , eqn: "Cv('f1040_tax') + Cv('f1040_other_taxes')", last_eval:0 });
g.setNode("f1040_credits",  { label: "credits", baselabel: "credits", form: "f1040", fullname: "CTC and Schedule 3, other credits", class: "a_node critical", val:0 , eqn: "Cv('f1040sch3_nonrefundable_total') + Cv('ctc_ws_1040_ctc')", last_eval:0 });
g.setNode("f1040_tax_minus_credits",  { label: "tax_minus_credits", baselabel: "tax_minus_credits", form: "f1040", fullname: "Tax minus credits", class: "a_node critical", val:0 , eqn: "max(Cv('f1040_pretotal_tax')-Cv('f1040_credits'), 0)", last_eval:0 });
g.setNode("f1040_total_tax",  { label: "total_tax", baselabel: "total_tax", form: "f1040", fullname: "Total tax", class: "a_node ", val:0 , eqn: "Cv('f1040_tax_minus_credits') + Cv('f1040sch4_aca_fee')", last_eval:0 });
g.setNode("f1040_federal_tax_withheld",  { label: "federal_tax_withheld", baselabel: "federal_tax_withheld", form: "f1040", fullname: "Federal income tax withheld from Forms W-2 and 1099", class: "a_node u", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_eitc",  { label: "eitc", baselabel: "eitc", form: "f1040", fullname: "Earned income credit (EIC)", class: "a_node ", val:0 , eqn: "eitc(Cv('f1040_AGI'), kids)", last_eval:0 });
g.setNode("f1040_actc",  { label: "actc", baselabel: "actc", form: "f1040", fullname: "Refundable child tax credit", class: "a_node kids", val:0 , eqn: "Cv('ctc_sch8812_refundable_ctc')", last_eval:0 });
g.setNode("f1040_ed_tc",  { label: "ed_tc", baselabel: "ed_tc", form: "f1040", fullname: "Refundable education credits", class: "a_node s_loans", val:0 , eqn: "Cv('f8863_refundable_credit')", last_eval:0 });
g.setNode("f1040_total_payments",  { label: "total_payments", baselabel: "total_payments", form: "f1040", fullname: "Total payments", class: "a_node ", val:0 , eqn: "Cv('f1040_federal_tax_withheld') + Cv('f1040_eitc') + Cv('f1040_actc') + Cv('f1040_ed_tc') + 0", last_eval:0 });
g.setNode("f1040_refund",  { label: "refund", baselabel: "refund", form: "f1040", fullname: "Refund", class: "a_node critical", val:0 , eqn: "max(Cv('f1040_total_payments')-Cv('f1040_total_tax'), 0)", last_eval:0 });
g.setNode("f1040_tax_owed",  { label: "tax_owed", baselabel: "tax_owed", form: "f1040", fullname: "Tax owed", class: "a_node critical", val:0 , eqn: "max(Cv('f1040_total_tax')-Cv('f1040_total_payments'), 0)", last_eval:0 });
g.setNode("f1040sch2_amt",  { label: "amt", baselabel: "amt", form: "f1040sch2", fullname: "Alternative minimum tax", class: "a_node itemizing", val:0 , eqn: "Cv('f6251_amt')", last_eval:0 });
g.setNode("f1040sch2_credit_repayment",  { label: "credit_repayment", baselabel: "credit_repayment", form: "f1040sch2", fullname: "Excess advance premium tax credit repayment. (UI)", class: "a_node u", val:0 , eqn: "0", last_eval:0 });
g.setNode("f1040sch3_ftc",  { label: "ftc", baselabel: "ftc", form: "f1040sch3", fullname: "Foreign tax credit", class: "a_node u", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040sch3_child_care",  { label: "child_care", baselabel: "child_care", form: "f1040sch3", fullname: "Dependent care expenses", class: "a_node u", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040sch3_ed_credits",  { label: "ed_credits", baselabel: "ed_credits", form: "f1040sch3", fullname: "Education credits via f8863", class: "a_node s_loans", val:0 , eqn: "Cv('f8863_nonrefundable_credit')", last_eval:0 });
g.setNode("f1040sch3_nonrefundable_total",  { label: "nonrefundable_total", baselabel: "nonrefundable_total", form: "f1040sch3", fullname: "Total nonrefundable credits", class: "a_node ", val:0 , eqn: "Cv('f1040sch3_ftc')+Cv('f1040sch3_child_care')+Cv('f1040sch3_ed_credits')", last_eval:0 });
g.setNode("f1040sch4_aca_fee",  { label: "aca_fee", baselabel: "aca_fee", form: "f1040sch4", fullname: "Health care individual responsibility", class: "a_node u", val:0 , eqn: "", last_eval:0 });
g.setNode("student_loan_ws_1040_student_loan_interest",  { label: "student_loan_interest", baselabel: "student_loan_interest", form: "student_loan_ws_1040", fullname: "Interest you paid in 2018 on qualified student loans", class: "a_node u s_loans", val:0 , eqn: "", last_eval:0 });
g.setNode("student_loan_ws_1040_loans_maxed",  { label: "loans_maxed", baselabel: "loans_maxed", form: "student_loan_ws_1040", fullname: "Student loan interest, maxed at $2,500", class: "a_node s_loans", val:0 , eqn: "min(Cv('student_loan_ws_1040_student_loan_interest'), 2500)", last_eval:0 });
g.setNode("student_loan_ws_1040_phase_out_pct",  { label: "phase_out_pct", baselabel: "phase_out_pct", form: "student_loan_ws_1040", fullname: "total income minus phase-out limit", class: "a_node s_loans", val:0 , eqn: "min(1, max(Cv('f1040_total_in') - ((fstatus()=='married') ? (135000) : (65000 )) , 0)/((fstatus()=='married') ? (30000) : (15000 )) )", last_eval:0 });
g.setNode("student_loan_ws_1040_phased_out_loans",  { label: "phased_out_loans", baselabel: "phased_out_loans", form: "student_loan_ws_1040", fullname: "phased-out loans", class: "a_node s_loans", val:0 , eqn: "Cv('student_loan_ws_1040_loans_maxed')*Cv('student_loan_ws_1040_phase_out_pct')", last_eval:0 });
g.setNode("student_loan_ws_1040_final_credit",  { label: "final_credit", baselabel: "final_credit", form: "student_loan_ws_1040", fullname: "Student loan interest credit", class: "a_node s_loans", val:0 , eqn: "max(Cv('student_loan_ws_1040_loans_maxed') - Cv('student_loan_ws_1040_phased_out_loans'), 0)", last_eval:0 });
g.setNode("ctc_ws_1040_two_thousand_per_child",  { label: "two_thousand_per_child", baselabel: "two_thousand_per_child", form: "ctc_ws_1040", fullname: "$2,000 per child under 17", class: "a_node kids", val:0 , eqn: "thousandkids()", last_eval:0 });
g.setNode("ctc_ws_1040_ctc_subtraction",  { label: "ctc_subtraction", baselabel: "ctc_subtraction", form: "ctc_ws_1040", fullname: "5% of AGI minus a filing-status dependent number", class: "a_node kids", val:0 , eqn: "ctc_status(Cv('f1040_AGI'))", last_eval:0 });
g.setNode("ctc_ws_1040_credit_remaining",  { label: "credit_remaining", baselabel: "credit_remaining", form: "ctc_ws_1040", fullname: "$2,000 per child minus the subtraction", class: "a_node kids", val:0 , eqn: "max(Cv('ctc_ws_1040_two_thousand_per_child') - Cv('ctc_ws_1040_ctc_subtraction'), 0)", last_eval:0 });
g.setNode("ctc_ws_1040_tax_minus_some_credits",  { label: "tax_minus_some_credits", baselabel: "tax_minus_some_credits", form: "ctc_ws_1040", fullname: "Calculated tax minus some credits", class: "a_node kids", val:0 , eqn: "Cv('f1040_tax') - Cv('f1040sch3_ed_credits')- Cv('f1040sch3_ftc')", last_eval:0 });
g.setNode("ctc_ws_1040_ctc",  { label: "ctc", baselabel: "ctc", form: "ctc_ws_1040", fullname: "Child tax credit", class: "a_node kids", val:0 , eqn: "min(Cv('ctc_ws_1040_tax_minus_some_credits'), Cv('ctc_ws_1040_credit_remaining'))", last_eval:0 });
g.setNode("ctc_sch8812_unused_ctc",  { label: "unused_ctc", baselabel: "unused_ctc", form: "ctc_sch8812", fullname: "CTC not used", class: "a_node kids", val:0 , eqn: "max(0, Cv('ctc_ws_1040_credit_remaining') - Cv('ctc_ws_1040_ctc'))", last_eval:0 });
g.setNode("ctc_sch8812_fourteen_kids",  { label: "fourteen_kids", baselabel: "fourteen_kids", form: "ctc_sch8812", fullname: "$1,400 per kid", class: "a_node kids", val:0 , eqn: "fourteenkids()", last_eval:0 });
g.setNode("ctc_sch8812_limited_unused",  { label: "limited_unused", baselabel: "limited_unused", form: "ctc_sch8812", fullname: "Limited unused CTC", class: "a_node kids", val:0 , eqn: "min(Cv('ctc_sch8812_unused_ctc'),Cv('ctc_sch8812_fourteen_kids'))", last_eval:0 });
g.setNode("ctc_sch8812_scaled_earned_income",  { label: "scaled_earned_income", baselabel: "scaled_earned_income", form: "ctc_sch8812", fullname: "15 percent of earned income-2500", class: "a_node kids", val:0 , eqn: "max(0, .15*(Cv('f1040_wages')-2500))", last_eval:0 });
g.setNode("ctc_sch8812_ss_and_medicare_withheld",  { label: "ss_and_medicare_withheld", baselabel: "ss_and_medicare_withheld", form: "ctc_sch8812", fullname: "Social security and medicare withheld on W-2 lines 4 and 6", class: "a_node u kids", val:0 , eqn: "", last_eval:0 });
g.setNode("ctc_sch8812_refundable_ctc",  { label: "refundable_ctc", baselabel: "refundable_ctc", form: "ctc_sch8812", fullname: "Refundable child tax credit", class: "a_node kids", val:0 , eqn: "actc(Cv('ctc_sch8812_limited_unused'), Cv('ctc_sch8812_scaled_earned_income'), Cv('ctc_sch8812_ss_and_medicare_withheld'), Cv('f1040_eitc'))", last_eval:0 });
g.setNode("f1040_tax_refund_ws_last_year_refund",  { label: "last_year_refund", baselabel: "last_year_refund", form: "f1040_tax_refund_ws", fullname: "Enter the income tax refund from Form(s) 1099­G, up to income taxes on last year's Schedule A", class: "a_node u", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_tax_refund_ws_last_year_itemized_deductions",  { label: "last_year_itemized_deductions", baselabel: "last_year_itemized_deductions", form: "f1040_tax_refund_ws", fullname: "Enter line 29 of your 2015 Schedule A", class: "a_node u", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_tax_refund_ws_almost_std_deduction",  { label: "almost_std_deduction", baselabel: "almost_std_deduction", form: "f1040_tax_refund_ws", fullname: "Last year's standard deduction", class: "a_node ", val:0 , eqn: "((fstatus()=='married') ? (6300) : (((fstatus()=='single') ? (6300) : (((fstatus()=='married filing jointly') ? (12600) : (((fstatus()=='head of household') ? (9300) : (0 )) )) )) )) ", last_eval:0 });
g.setNode("f1040_tax_refund_ws_srblind",  { label: "srblind", baselabel: "srblind", form: "f1040_tax_refund_ws", fullname: "Senior or blind exemption (blind not implemented)", class: "a_node ", val:0 , eqn: "( situations['.over_65'] + situations['.spouse_over_65'] ==1)* ((fstatus()=='married') ? (7600) : (((fstatus()=='single') ? (7900) : (((fstatus()=='married filing jointly') ? (13950) : (((fstatus()=='head of household') ? (10900) : (0 )) )) )) ))  + ( situations['.over_65'] + situations['.spouse_over_65'] ==2)* ((fstatus()=='married') ? (8850) : (((fstatus()=='single') ? (7900) : (((fstatus()=='married filing jointly') ? (15200) : (((fstatus()=='head of household') ? (12450) : (0 )) )) )) )) ", last_eval:0 });
g.setNode("f1040_tax_refund_ws_taxable_refund",  { label: "taxable_refund", baselabel: "taxable_refund", form: "f1040_tax_refund_ws", fullname: "Taxable tax refund", class: "a_node ", val:0 , eqn: " min(Cv('f1040_tax_refund_ws_last_year_refund'), max(Cv('f1040_tax_refund_ws_last_year_itemized_deductions') - (Cv('f1040_tax_refund_ws_almost_std_deduction')+Cv('f1040_tax_refund_ws_srblind')), 0))", last_eval:0 });
g.setNode("f1040_sched_a_medical_expenses",  { label: "medical_expenses", baselabel: "medical_expenses", form: "f1040_sched_a", fullname: "Medical and dental expenses", class: "a_node u itemizing", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_a_agi_scaled",  { label: "agi_scaled", baselabel: "agi_scaled", form: "f1040_sched_a", fullname: "AGI scaled", class: "a_node itemizing", val:0 , eqn: "Cv('f1040_AGI')* (( situations['.over_65'] + situations['.spouse_over_65'] ) ? (.075) : (.1))", last_eval:0 });
g.setNode("f1040_sched_a_excess_medical",  { label: "excess_medical", baselabel: "excess_medical", form: "f1040_sched_a", fullname: "Medical expenses minus fraction of AGI", class: "a_node itemizing", val:0 , eqn: "max(Cv('f1040_sched_a_medical_expenses') - Cv('f1040_sched_a_agi_scaled'), 0)", last_eval:0 });
g.setNode("f1040_sched_a_local_taxes",  { label: "local_taxes", baselabel: "local_taxes", form: "f1040_sched_a", fullname: "State/local Income OR general sales tax", class: "a_node u itemizing", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_a_real_estate_taxes",  { label: "real_estate_taxes", baselabel: "real_estate_taxes", form: "f1040_sched_a", fullname: "Real estate taxes", class: "a_node u itemizing", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_a_property_taxes",  { label: "property_taxes", baselabel: "property_taxes", form: "f1040_sched_a", fullname: "Personal property taxes", class: "a_node u itemizing", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_a_other_taxes",  { label: "other_taxes", baselabel: "other_taxes", form: "f1040_sched_a", fullname: "Other taxes", class: "a_node u itemizing", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_a_total_taxes_deducted",  { label: "total_taxes_deducted", baselabel: "total_taxes_deducted", form: "f1040_sched_a", fullname: "Total taxes paid to be deducted", class: "a_node itemizing", val:0 , eqn: "Cv('f1040_sched_a_local_taxes') + Cv('f1040_sched_a_real_estate_taxes') + Cv('f1040_sched_a_property_taxes') + Cv('f1040_sched_a_other_taxes') + 0", last_eval:0 });
g.setNode("f1040_sched_a_reported_mort_interest",  { label: "reported_mort_interest", baselabel: "reported_mort_interest", form: "f1040_sched_a", fullname: "Home mortgage interest/points reported on Form 1099", class: "a_node u itemizing mort", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_a_unreported_mort_interest",  { label: "unreported_mort_interest", baselabel: "unreported_mort_interest", form: "f1040_sched_a", fullname: "Home mortgage interest not reported on Form 1098", class: "a_node u itemizing mort", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_a_unreported_mort_points",  { label: "unreported_mort_points", baselabel: "unreported_mort_points", form: "f1040_sched_a", fullname: "Home mortgage points not reported on Form 1098", class: "a_node u itemizing mort", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_a_mort_insurance_premiums_in",  { label: "mort_insurance_premiums_in", baselabel: "mort_insurance_premiums_in", form: "f1040_sched_a", fullname: "Mortgage insurance premiums in", class: "a_node u itemizing mort", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_a_mort_insurance_limit",  { label: "mort_insurance_limit", baselabel: "mort_insurance_limit", form: "f1040_sched_a", fullname: "mort insurance limit", class: "a_node itemizing mort", val:0 , eqn: "(((Cv('f1040_AGI') - ((fstatus()=='married') ? (50000) : (100000 )) ) < 0) ? (1) : (max(0,min(1,1-Ceil((Cv('f1040_AGI') - ((fstatus()=='married') ? (50000) : (100000 )) )/1000)/10.))))", last_eval:0 });
g.setNode("f1040_sched_a_mort_insurance_premiums",  { label: "mort_insurance_premiums", baselabel: "mort_insurance_premiums", form: "f1040_sched_a", fullname: "Mortgage insurance premiums claimed", class: "a_node itemizing mort", val:0 , eqn: "Cv('f1040_sched_a_mort_insurance_premiums_in')*Cv('f1040_sched_a_mort_insurance_limit')", last_eval:0 });
g.setNode("f1040_sched_a_investment_interest",  { label: "investment_interest", baselabel: "investment_interest", form: "f1040_sched_a", fullname: "Investment interest", class: "a_node u itemizing", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_a_total_interest_deduction",  { label: "total_interest_deduction", baselabel: "total_interest_deduction", form: "f1040_sched_a", fullname: "Total interest to deduct", class: "a_node itemizing", val:0 , eqn: "Cv('f1040_sched_a_reported_mort_interest') + Cv('f1040_sched_a_unreported_mort_interest') + Cv('f1040_sched_a_unreported_mort_points') + Cv('f1040_sched_a_mort_insurance_premiums') + Cv('f1040_sched_a_investment_interest') + 0", last_eval:0 });
g.setNode("f1040_sched_a_charity_cash",  { label: "charity_cash", baselabel: "charity_cash", form: "f1040_sched_a", fullname: "Gifts to charity by cash or check", class: "a_node u itemizing", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_a_charity_noncash",  { label: "charity_noncash", baselabel: "charity_noncash", form: "f1040_sched_a", fullname: "Gifts to charity other than by cash or check", class: "a_node u itemizing", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_a_charity_carryover",  { label: "charity_carryover", baselabel: "charity_carryover", form: "f1040_sched_a", fullname: "Gifts to charity, carryover from prior year", class: "a_node u itemizing", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_a_charity_total",  { label: "charity_total", baselabel: "charity_total", form: "f1040_sched_a", fullname: "Gifts to charity, total", class: "a_node itemizing", val:0 , eqn: "Cv('f1040_sched_a_charity_cash') + Cv('f1040_sched_a_charity_noncash') + Cv('f1040_sched_a_charity_carryover') + 0", last_eval:0 });
g.setNode("f1040_sched_a_casualty_or_theft_losses",  { label: "casualty_or_theft_losses", baselabel: "casualty_or_theft_losses", form: "f1040_sched_a", fullname: "Casualty and Theft Losses", class: "a_node u itemizing", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_a_employee_expenses",  { label: "employee_expenses", baselabel: "employee_expenses", form: "f1040_sched_a", fullname: "Unreimbursed employee expenses—job travel, union dues, job education, etc.", class: "a_node u itemizing", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_a_tax_prep_fees",  { label: "tax_prep_fees", baselabel: "tax_prep_fees", form: "f1040_sched_a", fullname: "Tax prep fees", class: "a_node u itemizing", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_a_other_work_expenses",  { label: "other_work_expenses", baselabel: "other_work_expenses", form: "f1040_sched_a", fullname: "Other expenses—investment, safe deposit box, etc.", class: "a_node u itemizing", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_a_total_expenses",  { label: "total_expenses", baselabel: "total_expenses", form: "f1040_sched_a", fullname: "Total expenses", class: "a_node itemizing", val:0 , eqn: "Cv('f1040_sched_a_employee_expenses') + Cv('f1040_sched_a_tax_prep_fees') + Cv('f1040_sched_a_other_work_expenses') + 0", last_eval:0 });
g.setNode("f1040_sched_a_expenses_minus_agi_slice",  { label: "expenses_minus_agi_slice", baselabel: "expenses_minus_agi_slice", form: "f1040_sched_a", fullname: "Expenses minus fraction of AGI", class: "a_node itemizing", val:0 , eqn: "max(Cv('f1040_sched_a_total_expenses') - (Cv('f1040_AGI')* 0.02), 0)", last_eval:0 });
g.setNode("f1040_sched_a_other_deductions",  { label: "other_deductions", baselabel: "other_deductions", form: "f1040_sched_a", fullname: "Other deductions", class: "a_node u itemizing", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_a_total_itemized_deductions",  { label: "total_itemized_deductions", baselabel: "total_itemized_deductions", form: "f1040_sched_a", fullname: "Total itemized deductions (assuming income < $155k)", class: "a_node itemizing", val:0 , eqn: "Cv('f1040_sched_a_excess_medical') + Cv('f1040_sched_a_total_taxes_deducted') + Cv('f1040_sched_a_total_interest_deduction') + Cv('f1040_sched_a_charity_total') + Cv('f1040_sched_a_casualty_or_theft_losses') + Cv('f1040_sched_a_expenses_minus_agi_slice') + Cv('f1040_sched_a_other_deductions') + 0", last_eval:0 });
g.setNode("f1040_sched_e_rents_received",  { label: "rents_received", baselabel: "rents_received", form: "f1040_sched_e", fullname: "Rents received", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_e_royalties_received",  { label: "royalties_received", baselabel: "royalties_received", form: "f1040_sched_e", fullname: "Royalties received", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_e_rental_advertising",  { label: "rental_advertising", baselabel: "rental_advertising", form: "f1040_sched_e", fullname: "Advertising", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_e_rental_auto_and_travel",  { label: "rental_auto_and_travel", baselabel: "rental_auto_and_travel", form: "f1040_sched_e", fullname: "Auto and travel", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_e_rental_cleaning_and_maintenance",  { label: "rental_cleaning_and_maintenance", baselabel: "rental_cleaning_and_maintenance", form: "f1040_sched_e", fullname: "Cleaning and maintenance", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_e_rental_commissions",  { label: "rental_commissions", baselabel: "rental_commissions", form: "f1040_sched_e", fullname: "Commissions", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_e_rental_insurance",  { label: "rental_insurance", baselabel: "rental_insurance", form: "f1040_sched_e", fullname: "Insurance", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_e_rental_professional_fees",  { label: "rental_professional_fees", baselabel: "rental_professional_fees", form: "f1040_sched_e", fullname: "Legal and other professional fees", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_e_rental_management_fees",  { label: "rental_management_fees", baselabel: "rental_management_fees", form: "f1040_sched_e", fullname: "Management fees", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_e_rental_mortgage_interest",  { label: "rental_mortgage_interest", baselabel: "rental_mortgage_interest", form: "f1040_sched_e", fullname: "Mortgage interest paid to banks, etc", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_e_rental_other_interest",  { label: "rental_other_interest", baselabel: "rental_other_interest", form: "f1040_sched_e", fullname: "Other interest", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_e_rental_repairs",  { label: "rental_repairs", baselabel: "rental_repairs", form: "f1040_sched_e", fullname: "Repairs", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_e_rental_supplies",  { label: "rental_supplies", baselabel: "rental_supplies", form: "f1040_sched_e", fullname: "Supplies", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_e_rental_taxes",  { label: "rental_taxes", baselabel: "rental_taxes", form: "f1040_sched_e", fullname: "Taxes", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_e_rental_utilities",  { label: "rental_utilities", baselabel: "rental_utilities", form: "f1040_sched_e", fullname: "Utilities", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_e_rental_depreciation",  { label: "rental_depreciation", baselabel: "rental_depreciation", form: "f1040_sched_e", fullname: "Depreciation expense or depletion", class: "a_node have_rr", val:0 , eqn: "Cv('f4562_rental_property_depreciation')", last_eval:0 });
g.setNode("f1040_sched_e_rental_other_expenses",  { label: "rental_other_expenses", baselabel: "rental_other_expenses", form: "f1040_sched_e", fullname: "Other", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_e_royalty_expenses",  { label: "royalty_expenses", baselabel: "royalty_expenses", form: "f1040_sched_e", fullname: "Other", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f1040_sched_e_total_rental_expenses",  { label: "total_rental_expenses", baselabel: "total_rental_expenses", form: "f1040_sched_e", fullname: "Total expenses", class: "a_node have_rr", val:0 , eqn: "Cv('f1040_sched_e_rental_advertising') + Cv('f1040_sched_e_rental_auto_and_travel') + Cv('f1040_sched_e_rental_cleaning_and_maintenance') + Cv('f1040_sched_e_rental_commissions') + Cv('f1040_sched_e_rental_insurance') + Cv('f1040_sched_e_rental_professional_fees') + Cv('f1040_sched_e_rental_management_fees') + Cv('f1040_sched_e_rental_mortgage_interest') + Cv('f1040_sched_e_rental_other_interest') + Cv('f1040_sched_e_rental_repairs') + Cv('f1040_sched_e_rental_supplies') + Cv('f1040_sched_e_rental_taxes') + Cv('f1040_sched_e_rental_utilities') + Cv('f1040_sched_e_rental_depreciation') + Cv('f1040_sched_e_rental_other_expenses') + 0", last_eval:0 });
g.setNode("f1040_sched_e_net_rents",  { label: "net_rents", baselabel: "net_rents", form: "f1040_sched_e", fullname: "Rents minus expenses", class: "a_node have_rr", val:0 , eqn: "Cv('f1040_sched_e_rents_received') - Cv('f1040_sched_e_total_rental_expenses')", last_eval:0 });
g.setNode("f1040_sched_e_net_royalties",  { label: "net_royalties", baselabel: "net_royalties", form: "f1040_sched_e", fullname: "Royalties minus expenses", class: "a_node have_rr", val:0 , eqn: "Cv('f1040_sched_e_royalties_received') - Cv('f1040_sched_e_royalty_expenses')", last_eval:0 });
g.setNode("f1040_sched_e_deductible_rr_losses",  { label: "deductible_rr_losses", baselabel: "deductible_rr_losses", form: "f1040_sched_e", fullname: "Deductible rental real estate loss after limitation", class: "a_node have_rr", val:0 , eqn: "Cv('f8582_total_losses_8582')", last_eval:0 });
g.setNode("f1040_sched_e_sched_e_sum3",  { label: "sched_e_sum3", baselabel: "sched_e_sum3", form: "f1040_sched_e", fullname: "Total for line 3 for all rentals", class: "a_node have_rr", val:0 , eqn: "Cv('f1040_sched_e_rents_received')", last_eval:0 });
g.setNode("f1040_sched_e_sched_e_sum4",  { label: "sched_e_sum4", baselabel: "sched_e_sum4", form: "f1040_sched_e", fullname: "Total for line 4 for all royaltys", class: "a_node have_rr", val:0 , eqn: "Cv('f1040_sched_e_royalties_received')", last_eval:0 });
g.setNode("f1040_sched_e_sched_e_sum12",  { label: "sched_e_sum12", baselabel: "sched_e_sum12", form: "f1040_sched_e", fullname: "Total for line 12 for all propertiess", class: "a_node have_rr", val:0 , eqn: "Cv('f1040_sched_e_mortgage_interest')", last_eval:0 });
g.setNode("f1040_sched_e_sched_e_sum18",  { label: "sched_e_sum18", baselabel: "sched_e_sum18", form: "f1040_sched_e", fullname: "Total for line 18 for all propertiess", class: "a_node have_rr", val:0 , eqn: "Cv('f1040_sched_e_depreciation')", last_eval:0 });
g.setNode("f1040_sched_e_sched_e_sum20",  { label: "sched_e_sum20", baselabel: "sched_e_sum20", form: "f1040_sched_e", fullname: "Total for line 20 for all propertiess", class: "a_node have_rr", val:0 , eqn: "Cv('f1040_sched_e_total_rental_expenses')", last_eval:0 });
g.setNode("f1040_sched_e_sched_e_income",  { label: "sched_e_income", baselabel: "sched_e_income", form: "f1040_sched_e", fullname: "Positive RR Income (PI)", class: "a_node have_rr", val:0 , eqn: "max(0,Cv('f1040_sched_e_net_rents')) + max(0,Cv('f1040_sched_e_net_royalties'))", last_eval:0 });
g.setNode("f1040_sched_e_rr_losses",  { label: "rr_losses", baselabel: "rr_losses", form: "f1040_sched_e", fullname: "Royalty losses plus possibly limited rental losses (PI)", class: "a_node have_rr", val:0 , eqn: "((Cv('f1040_sched_e_rents_received') > 0) ? (Cv('f1040_sched_e_deductible_rr_losses')) : (min(0,Cv('f1040_sched_e_net_rents')))) + min(Cv('f1040_sched_e_net_royalties'),0)", last_eval:0 });
g.setNode("f1040_sched_e_rr_income",  { label: "rr_income", baselabel: "rr_income", form: "f1040_sched_e", fullname: "Total rents and royalties", class: "a_node have_rr", val:0 , eqn: "Cv('f1040_sched_e_sched_e_income') + Cv('f1040_sched_e_rr_losses') + 0", last_eval:0 });
g.setNode("f4562_rental_property_value",  { label: "rental_property_value", baselabel: "rental_property_value", form: "f4562", fullname: "Rental property value, for 27.5yr straight line depreciation", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f4562_rental_property_depreciation",  { label: "rental_property_depreciation", baselabel: "rental_property_depreciation", form: "f4562", fullname: "Rental property depreciation", class: "a_node have_rr", val:0 , eqn: "Cv('f4562_rental_property_value')/27.5", last_eval:0 });
g.setNode("f8582_ws1_8582_net_gain",  { label: "ws1_8582_net_gain", baselabel: "ws1_8582_net_gain", form: "f8582", fullname: "Net income", class: "a_node have_rr", val:0 , eqn: "max(Cv('f1040_sched_e_rents_received') - Cv('f1040_sched_e_total_rental_expenses'), 0)", last_eval:0 });
g.setNode("f8582_ws1_8582_net_loss",  { label: "ws1_8582_net_loss", baselabel: "ws1_8582_net_loss", form: "f8582", fullname: "Net loss", class: "a_node have_rr", val:0 , eqn: "min(Cv('f1040_sched_e_rents_received') - Cv('f1040_sched_e_total_rental_expenses'), 0)", last_eval:0 });
g.setNode("f8582_ws1_8582_prior_loss",  { label: "ws1_8582_prior_loss", baselabel: "ws1_8582_prior_loss", form: "f8582", fullname: "Prior year carryover real estate loss", class: "a_node u have_rr", val:0 , eqn: "", last_eval:0 });
g.setNode("f8582_f8582_net_in",  { label: "f8582_net_in", baselabel: "f8582_net_in", form: "f8582", fullname: "Net income", class: "a_node have_rr", val:0 , eqn: "Cv('f8582_ws1_8582_net_gain')", last_eval:0 });
g.setNode("f8582_f8582_net_loss",  { label: "f8582_net_loss", baselabel: "f8582_net_loss", form: "f8582", fullname: "Net loss", class: "a_node have_rr", val:0 , eqn: "Cv('f8582_ws1_8582_net_loss')", last_eval:0 });
g.setNode("f8582_f8582_carryover",  { label: "f8582_carryover", baselabel: "f8582_carryover", form: "f8582", fullname: "Prior year carryover", class: "a_node have_rr", val:0 , eqn: "((Cv('f8582_ws1_8582_prior_loss') < 0) ? (Cv('f8582_ws1_8582_prior_loss')) : (-Cv('f8582_ws1_8582_prior_loss')))", last_eval:0 });
g.setNode("f8582_f8582_total_real_in",  { label: "f8582_total_real_in", baselabel: "f8582_total_real_in", form: "f8582", fullname: "Sum", class: "a_node have_rr", val:0 , eqn: "Cv('f8582_f8582_net_in') + Cv('f8582_f8582_net_loss') + Cv('f8582_f8582_carryover') + 0", last_eval:0 });
g.setNode("f8582_f8582_commercial_revitalization",  { label: "f8582_commercial_revitalization", baselabel: "f8582_commercial_revitalization", form: "f8582", fullname: "Commercial revitalization deductions (UI)", class: "a_node have_rr", val:0 , eqn: "0", last_eval:0 });
g.setNode("f8582_f8582_passive_activities",  { label: "f8582_passive_activities", baselabel: "f8582_passive_activities", form: "f8582", fullname: "Passive activity income (UI)", class: "a_node have_rr", val:0 , eqn: "0", last_eval:0 });
g.setNode("f8582_f8582_total_in",  { label: "f8582_total_in", baselabel: "f8582_total_in", form: "f8582", fullname: "Total in", class: "a_node have_rr", val:0 , eqn: "Cv('f8582_f8582_total_real_in') + Cv('f8582_f8582_commercial_revitalization') + Cv('f8582_f8582_passive_activities') + 0", last_eval:0 });
g.setNode("f8582_f8582_min",  { label: "f8582_min", baselabel: "f8582_min", form: "f8582", fullname: "the smaller of the loss on line 1d or the loss on line 4", class: "a_node have_rr", val:0 , eqn: "max(min(Cv('f8582_f8582_total_real_in'),0), min(Cv('f8582_f8582_total_in'),0))", last_eval:0 });
g.setNode("f8582_magi",  { label: "magi", baselabel: "magi", form: "f8582", fullname: "MAGI", class: "a_node have_rr", val:0 , eqn: "Cv('f1040_MAGI')", last_eval:0 });
g.setNode("f8582_f8582_half",  { label: "f8582_half", baselabel: "f8582_half", form: "f8582", fullname: "Half of line 8, up to 25k", class: "a_node have_rr", val:0 , eqn: "-min(25000, max(150000 - max(Cv('f8582_magi'), 0), 0)/2.)", last_eval:0 });
g.setNode("f8582_allowed_real_losses",  { label: "allowed_real_losses", baselabel: "allowed_real_losses", form: "f8582", fullname: "Allowed real estate losses", class: "a_node have_rr", val:0 , eqn: "max(Cv('f8582_f8582_min'), Cv('f8582_f8582_half'))", last_eval:0 });
g.setNode("f8582_carryover_to_next_year",  { label: "carryover_to_next_year", baselabel: "carryover_to_next_year", form: "f8582", fullname: "Carry this over to next year", class: "a_node have_rr", val:0 , eqn: "Cv('f8582_f8582_total_real_in') - Cv('f8582_allowed_real_losses')", last_eval:0 });
g.setNode("f8582_total_gains_8582",  { label: "total_gains_8582", baselabel: "total_gains_8582", form: "f8582", fullname: "Total (UI)", class: "a_node have_rr", val:0 , eqn: "0", last_eval:0 });
g.setNode("f8582_total_losses_8582",  { label: "total_losses_8582", baselabel: "total_losses_8582", form: "f8582", fullname: "Total loss", class: "a_node have_rr", val:0 , eqn: "-max(-Cv('f8582_allowed_real_losses')+Cv('f8582_total_gains_8582'), 0)", last_eval:0 });
g.setNode("f6251_taxable_income",  { label: "taxable_income", baselabel: "taxable_income", form: "f6251", fullname: "AGI minus deductions", class: "a_node itemizing", val:0 , eqn: "Cv('f1040_taxable_income')", last_eval:0 });
g.setNode("f6251_taxes_deducted",  { label: "taxes_deducted", baselabel: "taxes_deducted", form: "f6251", fullname: "State/local/other deducted on Schedule A or std deduction", class: "a_node itemizing", val:0 , eqn: "((Cv('f1040_sched_a_total_itemized_deductions')>0) ? (Cv('f1040_sched_a_total_taxes_deducted')) : (Cv('f1040_std_deduction')))", last_eval:0 });
g.setNode("f6251_amt_refund_deduction",  { label: "amt_refund_deduction", baselabel: "amt_refund_deduction", form: "f6251", fullname: "Tax refund from Form 1040, line 10 or line 21 (only L10 implemented)", class: "a_node itemizing", val:0 , eqn: "Cv('f1040sch1_taxable_tax_refunds')", last_eval:0 });
g.setNode("f6251_amt_investment_expense_deduction",  { label: "amt_investment_expense_deduction", baselabel: "amt_investment_expense_deduction", form: "f6251", fullname: "Investment interest expense (UI)", class: "a_node itemizing", val:0 , eqn: "0", last_eval:0 });
g.setNode("f6251_amt_depletion_deduction",  { label: "amt_depletion_deduction", baselabel: "amt_depletion_deduction", form: "f6251", fullname: "Depletion (UI)", class: "a_node itemizing", val:0 , eqn: "0", last_eval:0 });
g.setNode("f6251_nold",  { label: "nold", baselabel: "nold", form: "f6251", fullname: "NOLD (UI)", class: "a_node itemizing", val:0 , eqn: "0", last_eval:0 });
g.setNode("f6251_amt_nold",  { label: "amt_nold", baselabel: "amt_nold", form: "f6251", fullname: "Alt NOLD (UI)", class: "a_node itemizing", val:0 , eqn: "0", last_eval:0 });
g.setNode("f6251_amt_income",  { label: "amt_income", baselabel: "amt_income", form: "f6251", fullname: "Alternative minimum taxable income. (PI)", class: "a_node itemizing", val:0 , eqn: "Cv('f6251_taxable_income') + Cv('f6251_taxes_deducted') + Cv('f6251_amt_refund_deduction') + Cv('f6251_amt_investment_expense_deduction') + Cv('f6251_amt_depletion_deduction') + Cv('f6251_nold') + Cv('f6251_amt_nold')", last_eval:0 });
g.setNode("f6251_amt_exemption",  { label: "amt_exemption", baselabel: "amt_exemption", form: "f6251", fullname: "AMT exemption", class: "a_node itemizing", val:0 , eqn: "get_amt_exemption(Cv('f6251_amt_income'))", last_eval:0 });
g.setNode("f6251_amt_in_minus_exemption",  { label: "amt_in_minus_exemption", baselabel: "amt_in_minus_exemption", form: "f6251", fullname: "AMT income minus exemption", class: "a_node itemizing", val:0 , eqn: "Cv('f6251_amt_income')-Cv('f6251_amt_exemption')", last_eval:0 });
g.setNode("f6251_amt_preftc",  { label: "amt_preftc", baselabel: "amt_preftc", form: "f6251", fullname: "Tentative AMT pre-FTC (Simplified)", class: "a_node itemizing", val:0 , eqn: "get_tamt(Cv('f6251_amt_in_minus_exemption'))", last_eval:0 });
g.setNode("f6251_amt_ftc",  { label: "amt_ftc", baselabel: "amt_ftc", form: "f6251", fullname: "AMT foreign tax credit (UI)", class: "a_node itemizing", val:0 , eqn: "0", last_eval:0 });
g.setNode("f6251_amt_tentative",  { label: "amt_tentative", baselabel: "amt_tentative", form: "f6251", fullname: "Tentative AMT", class: "a_node itemizing", val:0 , eqn: "Cv('f6251_amt_preftc')-Cv('f6251_amt_ftc')", last_eval:0 });
g.setNode("f6251_tax_from_1040",  { label: "tax_from_1040", baselabel: "tax_from_1040", form: "f6251", fullname: "Tax from F1040", class: "a_node itemizing", val:0 , eqn: "Cv('f1040_tax')+Cv('f1040sch2_credit_repayment')-Cv('f1040sch3_ftc')", last_eval:0 });
g.setNode("f6251_amt",  { label: "amt", baselabel: "amt", form: "f6251", fullname: "AMT", class: "a_node itemizing", val:0 , eqn: "max(Cv('f6251_amt_tentative') - Cv('f6251_tax_from_1040'), 0)", last_eval:0 });
g.setNode("f8863_education_expenses_1",  { label: "education_expenses_1", baselabel: "education_expenses_1", form: "f8863", fullname: "Education expenses (student 1)", class: "a_node u s_loans", val:0 , eqn: "", last_eval:0 });
g.setNode("f8863_scaled_education_expenses_1",  { label: "scaled_education_expenses_1", baselabel: "scaled_education_expenses_1", form: "f8863", fullname: "Limited Education expenses (s1)", class: "a_node s_loans", val:0 , eqn: "max(.25*(min(Cv('f8863_education_expenses_1'), 4000)-2000),0) ", last_eval:0 });
g.setNode("f8863_rescaled_education_expenses_1",  { label: "rescaled_education_expenses_1", baselabel: "rescaled_education_expenses_1", form: "f8863", fullname: "Relimited Education expenses (s1)", class: "a_node s_loans", val:0 , eqn: "((Cv('f8863_education_expenses_1')<=2000) ? (Cv('f8863_education_expenses_1')) : (Cv('f8863_scaled_education_expenses_1')+2000))", last_eval:0 });
g.setNode("f8863_education_expenses_2",  { label: "education_expenses_2", baselabel: "education_expenses_2", form: "f8863", fullname: "Education expenses (student 2)", class: "a_node u s_loans", val:0 , eqn: "", last_eval:0 });
g.setNode("f8863_scaled_education_expenses_2",  { label: "scaled_education_expenses_2", baselabel: "scaled_education_expenses_2", form: "f8863", fullname: "Limited Education expenses (s2)", class: "a_node s_loans", val:0 , eqn: "max(.25*(min(Cv('f8863_education_expenses_2'), 4000)-2000),0) ", last_eval:0 });
g.setNode("f8863_rescaled_education_expenses_2",  { label: "rescaled_education_expenses_2", baselabel: "rescaled_education_expenses_2", form: "f8863", fullname: "Relimited Education expenses (s2)", class: "a_node s_loans", val:0 , eqn: "((Cv('f8863_education_expenses_2')<=2000) ? (Cv('f8863_education_expenses_2')) : (Cv('f8863_scaled_education_expenses_2')+2000))", last_eval:0 });
g.setNode("f8863_education_expenses_3",  { label: "education_expenses_3", baselabel: "education_expenses_3", form: "f8863", fullname: "Education expenses (student 3)", class: "a_node u s_loans", val:0 , eqn: "", last_eval:0 });
g.setNode("f8863_scaled_education_expenses_3",  { label: "scaled_education_expenses_3", baselabel: "scaled_education_expenses_3", form: "f8863", fullname: "Limited Education expenses (s3)", class: "a_node s_loans", val:0 , eqn: "max(0,.25*(min(Cv('f8863_education_expenses_3'), 4000)-2000),0) ", last_eval:0 });
g.setNode("f8863_rescaled_education_expenses_3",  { label: "rescaled_education_expenses_3", baselabel: "rescaled_education_expenses_3", form: "f8863", fullname: "Relimited Education expenses (s3)", class: "a_node s_loans", val:0 , eqn: "((Cv('f8863_education_expenses_3')<=2000) ? (Cv('f8863_education_expenses_3')) : (Cv('f8863_scaled_education_expenses_3')+2000))", last_eval:0 });
g.setNode("f8863_adjusted_qualified_expenses",  { label: "adjusted_qualified_expenses", baselabel: "adjusted_qualified_expenses", form: "f8863", fullname: "Total adjusted qualified expenses, all students", class: "a_node u s_loans", val:0 , eqn: "", last_eval:0 });
g.setNode("f8863_total_limited_expenses",  { label: "total_limited_expenses", baselabel: "total_limited_expenses", form: "f8863", fullname: "Total limited expenses", class: "a_node s_loans", val:0 , eqn: "Cv('f8863_rescaled_education_expenses_1') + Cv('f8863_rescaled_education_expenses_2') + Cv('f8863_rescaled_education_expenses_3') + 0", last_eval:0 });
g.setNode("f8863_baseline",  { label: "baseline", baselabel: "baseline", form: "f8863", fullname: "90 or 180k", class: "a_node s_loans", val:0 , eqn: "((fstatus()=='married filing jointly') ? (180000) : (90000 )) ", last_eval:0 });
g.setNode("f8863_ninety_k_minus_agi",  { label: "ninety_k_minus_agi", baselabel: "ninety_k_minus_agi", form: "f8863", fullname: "Remaining after AGI subtraction", class: "a_node s_loans", val:0 , eqn: "max(0, Cv('f8863_baseline') - Cv('f1040_AGI'))", last_eval:0 });
g.setNode("f8863_fraction",  { label: "fraction", baselabel: "fraction", form: "f8863", fullname: "Fraction allowed", class: "a_node s_loans", val:0 , eqn: "max(min(1, Cv('f8863_ninety_k_minus_agi')/((fstatus()=='married filing jointly') ? (20000) : (10000 )) ), 0)", last_eval:0 });
g.setNode("f8863_unscaled_credit",  { label: "unscaled_credit", baselabel: "unscaled_credit", form: "f8863", fullname: "Unscaled credit", class: "a_node s_loans", val:0 , eqn: "Cv('f8863_total_limited_expenses')*Cv('f8863_fraction')", last_eval:0 });
g.setNode("f8863_under_24",  { label: "under_24", baselabel: "under_24", form: "f8863", fullname: "If you're under 24, 1", class: "a_node u s_loans", val:0 , eqn: "", last_eval:0 });
g.setNode("f8863_refundable_credit",  { label: "refundable_credit", baselabel: "refundable_credit", form: "f8863", fullname: "Refundable education credit", class: "a_node s_loans", val:0 , eqn: "((Cv('f8863_under_24')<0) ? (Cv('f8863_unscaled_credit')*.4) : (0))", last_eval:0 });
g.setNode("f8863_remaining_credit",  { label: "remaining_credit", baselabel: "remaining_credit", form: "f8863", fullname: "Remaining tentative credit", class: "a_node s_loans", val:0 , eqn: "Cv('f8863_unscaled_credit') - Cv('f8863_refundable_credit')", last_eval:0 });
g.setNode("f8863_aqe",  { label: "aqe", baselabel: "aqe", form: "f8863", fullname: "20% of Adjusted qualified expenses or 1k", class: "a_node s_loans", val:0 , eqn: "min(1000, Cv('f8863_adjusted_qualified_expenses')) *.2", last_eval:0 });
g.setNode("f8863_baseline2",  { label: "baseline2", baselabel: "baseline2", form: "f8863", fullname: "67k or 134k", class: "a_node s_loans", val:0 , eqn: "((fstatus()=='married filing jointly') ? (134000) : (67000 )) ", last_eval:0 });
g.setNode("f8863_sixty_seven_k_less_agi",  { label: "sixty_seven_k_less_agi", baselabel: "sixty_seven_k_less_agi", form: "f8863", fullname: "Remaining after AGI subtraction", class: "a_node s_loans", val:0 , eqn: "Cv('f8863_baseline2')-Cv('f1040_AGI')", last_eval:0 });
g.setNode("f8863_fraction2",  { label: "fraction2", baselabel: "fraction2", form: "f8863", fullname: "Fraction allowed", class: "a_node s_loans", val:0 , eqn: "max(min(1, Cv('f8863_sixty_seven_k_less_agi')/((fstatus()=='married filing jointly') ? (20000) : (10000 )) ), 0)", last_eval:0 });
g.setNode("f8863_ws_exclusions",  { label: "ws_exclusions", baselabel: "ws_exclusions", form: "f8863", fullname: "Exclusions from the worksheet in the instructions", class: "a_node u s_loans", val:0 , eqn: "", last_eval:0 });
g.setNode("f8863_frac_allowed",  { label: "frac_allowed", baselabel: "frac_allowed", form: "f8863", fullname: "Fraction allowed", class: "a_node s_loans", val:0 , eqn: "Cv('f8863_fraction2')*Cv('f8863_aqe')", last_eval:0 });
g.setNode("f8863_nonrefundable_credit",  { label: "nonrefundable_credit", baselabel: "nonrefundable_credit", form: "f8863", fullname: "Nonrefundable credit", class: "a_node s_loans", val:0 , eqn: "Cv('f8863ws_limited_credit')", last_eval:0 });
g.setNode("f8863ws_credit_sum",  { label: "credit_sum", baselabel: "credit_sum", form: "f8863ws", fullname: "Lines 9 plus 18", class: "a_node s_loans", val:0 , eqn: "Cv('f8863_remaining_credit')+Cv('f8863_frac_allowed')", last_eval:0 });
g.setNode("f8863ws_tax",  { label: "tax", baselabel: "tax", form: "f8863ws", fullname: "Tax from 1040", class: "a_node s_loans", val:0 , eqn: "Cv('f1040_tax')", last_eval:0 });
g.setNode("f8863ws_other_credits",  { label: "other_credits", baselabel: "other_credits", form: "f8863ws", fullname: "FTC and child care", class: "a_node s_loans", val:0 , eqn: "Cv('f1040sch3_ftc') + Cv('f1040sch3_child_care')", last_eval:0 });
g.setNode("f8863ws_diff",  { label: "diff", baselabel: "diff", form: "f8863ws", fullname: "Tax minus credits", class: "a_node s_loans", val:0 , eqn: "max(0, Cv('f8863ws_tax')-Cv('f8863ws_other_credits'))", last_eval:0 });
g.setNode("f8863ws_limited_credit",  { label: "limited_credit", baselabel: "limited_credit", form: "f8863ws", fullname: "Limited nonrefundable credit", class: "a_node s_loans", val:0 , eqn: "min(Cv('f8863ws_diff'), Cv('f8863ws_credit_sum'))", last_eval:0 });


var nodestorage=[]
var edgestorage=[]

var fixboxsize= function(node) {
  // Round the corners of the nodes
  node.rx = node.ry = 5;
  size = Math.sqrt(Math.max(node.val, 1000));
  //node.width = size*2.5;
  node.height = size*.9;
  node.label = node.baselabel + ": " + node.val
};

var fb2 = function(v){
    fixboxsize(g.node(v));
}

g.nodes().forEach(fb2);

var set_edges = function(from, toset){
    if (typeof g._nodes[from] === "undefined") return;
    for (i in toset){
        if (toset[i]=="") return;
        if (typeof g._nodes[toset[i]] === "undefined") return;
        g.setEdge(toset[i], from);
    }
}

// Set up edges, no special attributes.
var reedge = function(){

set_edges("f1040sch1_taxable_tax_refunds", ["f1040_tax_refund_ws_taxable_refund",  ""])
set_edges("f1040sch1_rr_income", ["f1040_sched_e_rr_income",  ""])
set_edges("f1040sch1_sch1_magi_subtotal", ["f1040sch1_taxable_tax_refunds", "f1040sch1_alimony", "f1040sch1_sched_c", "f1040sch1_cap_gains", "f1040sch1_farm_income", "f1040sch1_unemployment", "f1040sch1_other_in",  ""])
set_edges("f1040sch1_student_loan_interest_ded", ["student_loan_ws_1040_final_credit",  ""])
set_edges("f1040sch1_subtractions_from_income", ["f1040sch1_ira_deduction", "f1040sch1_student_loan_interest_ded",  ""])
set_edges("f1040_MAGI", ["f1040sch1_sch1_magi_subtotal", "f1040_wages", "f1040_interest", "f1040_dividends", "f1040_iras_pensions", "f1040_taxable_ss_benefits",  ""])
set_edges("f1040_total_in", ["f1040_MAGI", "f1040sch1_rr_income",  ""])
set_edges("f1040_AGI", ["f1040_total_in", "f1040sch1_subtractions_from_income",  ""])
set_edges("f1040_deductions", ["f1040_std_deduction", "f1040_sched_a_total_itemized_deductions",  ""])
set_edges("f1040_taxable_income", ["f1040_AGI", "f1040_deductions", "f1040_qbi",  ""])
set_edges("f1040_tax", ["f1040_taxable_income",  ""])
set_edges("f1040_other_taxes", ["f1040sch2_amt", "f1040sch2_credit_repayment",  ""])
set_edges("f1040_pretotal_tax", ["f1040_tax", "f1040_other_taxes",  ""])
set_edges("f1040_credits", ["f1040sch3_nonrefundable_total", "ctc_ws_1040_ctc",  ""])
set_edges("f1040_tax_minus_credits", ["f1040_pretotal_tax", "f1040_credits",  ""])
set_edges("f1040_total_tax", ["f1040_tax_minus_credits", "f1040sch4_aca_fee",  ""])
set_edges("f1040_eitc", ["f1040_AGI",  ""])
set_edges("f1040_actc", ["ctc_sch8812_refundable_ctc",  ""])
set_edges("f1040_ed_tc", ["f8863_refundable_credit",  ""])
set_edges("f1040_total_payments", ["f1040_federal_tax_withheld", "f1040_eitc", "f1040_actc", "f1040_ed_tc",  ""])
set_edges("f1040_refund", ["f1040_total_payments", "f1040_total_tax",  ""])
set_edges("f1040_tax_owed", ["f1040_total_tax", "f1040_total_payments",  ""])
set_edges("f1040sch2_amt", ["f6251_amt",  ""])
set_edges("f1040sch3_ed_credits", ["f8863_nonrefundable_credit",  ""])
set_edges("f1040sch3_nonrefundable_total", ["f1040sch3_ftc", "f1040sch3_child_care", "f1040sch3_ed_credits",  ""])
set_edges("student_loan_ws_1040_loans_maxed", ["student_loan_ws_1040_student_loan_interest",  ""])
set_edges("student_loan_ws_1040_phase_out_pct", ["f1040_total_in",  ""])
set_edges("student_loan_ws_1040_phased_out_loans", ["student_loan_ws_1040_loans_maxed", "student_loan_ws_1040_phase_out_pct",  ""])
set_edges("student_loan_ws_1040_final_credit", ["student_loan_ws_1040_loans_maxed", "student_loan_ws_1040_phased_out_loans",  ""])
set_edges("ctc_ws_1040_ctc_subtraction", ["f1040_AGI",  ""])
set_edges("ctc_ws_1040_credit_remaining", ["ctc_ws_1040_two_thousand_per_child", "ctc_ws_1040_ctc_subtraction",  ""])
set_edges("ctc_ws_1040_tax_minus_some_credits", ["f1040_tax", "f1040sch3_ed_credits", "f1040sch3_ftc",  ""])
set_edges("ctc_ws_1040_ctc", ["ctc_ws_1040_tax_minus_some_credits", "ctc_ws_1040_credit_remaining",  ""])
set_edges("ctc_sch8812_unused_ctc", ["ctc_ws_1040_credit_remaining", "ctc_ws_1040_ctc",  ""])
set_edges("ctc_sch8812_limited_unused", ["ctc_sch8812_unused_ctc", "ctc_sch8812_fourteen_kids",  ""])
set_edges("ctc_sch8812_scaled_earned_income", ["f1040_wages",  ""])
set_edges("ctc_sch8812_refundable_ctc", ["ctc_sch8812_limited_unused", "ctc_sch8812_scaled_earned_income", "ctc_sch8812_ss_and_medicare_withheld", "f1040_eitc",  ""])
set_edges("f1040_tax_refund_ws_taxable_refund", ["f1040_tax_refund_ws_last_year_refund", "f1040_tax_refund_ws_last_year_itemized_deductions", "f1040_tax_refund_ws_almost_std_deduction", "f1040_tax_refund_ws_srblind",  ""])
set_edges("f1040_sched_a_agi_scaled", ["f1040_AGI",  ""])
set_edges("f1040_sched_a_excess_medical", ["f1040_sched_a_medical_expenses", "f1040_sched_a_agi_scaled",  ""])
set_edges("f1040_sched_a_total_taxes_deducted", ["f1040_sched_a_local_taxes", "f1040_sched_a_real_estate_taxes", "f1040_sched_a_property_taxes", "f1040_sched_a_other_taxes",  ""])
set_edges("f1040_sched_a_mort_insurance_limit", ["f1040_AGI", "f1040_AGI",  ""])
set_edges("f1040_sched_a_mort_insurance_premiums", ["f1040_sched_a_mort_insurance_premiums_in", "f1040_sched_a_mort_insurance_limit",  ""])
set_edges("f1040_sched_a_total_interest_deduction", ["f1040_sched_a_reported_mort_interest", "f1040_sched_a_unreported_mort_interest", "f1040_sched_a_unreported_mort_points", "f1040_sched_a_mort_insurance_premiums", "f1040_sched_a_investment_interest",  ""])
set_edges("f1040_sched_a_charity_total", ["f1040_sched_a_charity_cash", "f1040_sched_a_charity_noncash", "f1040_sched_a_charity_carryover",  ""])
set_edges("f1040_sched_a_total_expenses", ["f1040_sched_a_employee_expenses", "f1040_sched_a_tax_prep_fees", "f1040_sched_a_other_work_expenses",  ""])
set_edges("f1040_sched_a_expenses_minus_agi_slice", ["f1040_sched_a_total_expenses", "f1040_AGI",  ""])
set_edges("f1040_sched_a_total_itemized_deductions", ["f1040_sched_a_excess_medical", "f1040_sched_a_total_taxes_deducted", "f1040_sched_a_total_interest_deduction", "f1040_sched_a_charity_total", "f1040_sched_a_casualty_or_theft_losses", "f1040_sched_a_expenses_minus_agi_slice", "f1040_sched_a_other_deductions",  ""])
set_edges("f1040_sched_e_rental_depreciation", ["f4562_rental_property_depreciation",  ""])
set_edges("f1040_sched_e_total_rental_expenses", ["f1040_sched_e_rental_advertising", "f1040_sched_e_rental_auto_and_travel", "f1040_sched_e_rental_cleaning_and_maintenance", "f1040_sched_e_rental_commissions", "f1040_sched_e_rental_insurance", "f1040_sched_e_rental_professional_fees", "f1040_sched_e_rental_management_fees", "f1040_sched_e_rental_mortgage_interest", "f1040_sched_e_rental_other_interest", "f1040_sched_e_rental_repairs", "f1040_sched_e_rental_supplies", "f1040_sched_e_rental_taxes", "f1040_sched_e_rental_utilities", "f1040_sched_e_rental_depreciation", "f1040_sched_e_rental_other_expenses",  ""])
set_edges("f1040_sched_e_net_rents", ["f1040_sched_e_rents_received", "f1040_sched_e_total_rental_expenses",  ""])
set_edges("f1040_sched_e_net_royalties", ["f1040_sched_e_royalties_received", "f1040_sched_e_royalty_expenses",  ""])
set_edges("f1040_sched_e_deductible_rr_losses", ["f8582_total_losses_8582",  ""])
set_edges("f1040_sched_e_sched_e_sum3", ["f1040_sched_e_rents_received",  ""])
set_edges("f1040_sched_e_sched_e_sum4", ["f1040_sched_e_royalties_received",  ""])
set_edges("f1040_sched_e_sched_e_sum12", ["f1040_sched_e_mortgage_interest",  ""])
set_edges("f1040_sched_e_sched_e_sum18", ["f1040_sched_e_depreciation",  ""])
set_edges("f1040_sched_e_sched_e_sum20", ["f1040_sched_e_total_rental_expenses",  ""])
set_edges("f1040_sched_e_sched_e_income", ["f1040_sched_e_net_rents", "f1040_sched_e_net_royalties",  ""])
set_edges("f1040_sched_e_rr_losses", ["f1040_sched_e_rents_received", "f1040_sched_e_deductible_rr_losses", "f1040_sched_e_net_royalties",  ""])
set_edges("f1040_sched_e_rr_income", ["f1040_sched_e_sched_e_income", "f1040_sched_e_rr_losses",  ""])
set_edges("f4562_rental_property_depreciation", ["f4562_rental_property_value",  ""])
set_edges("f8582_ws1_8582_net_gain", ["f1040_sched_e_rents_received", "f1040_sched_e_total_rental_expenses",  ""])
set_edges("f8582_ws1_8582_net_loss", ["f1040_sched_e_rents_received", "f1040_sched_e_total_rental_expenses",  ""])
set_edges("f8582_f8582_net_in", ["f8582_ws1_8582_net_gain",  ""])
set_edges("f8582_f8582_net_loss", ["f8582_ws1_8582_net_loss",  ""])
set_edges("f8582_f8582_carryover", ["f8582_ws1_8582_prior_loss", "f8582_ws1_8582_prior_loss", "f8582_ws1_8582_prior_loss",  ""])
set_edges("f8582_f8582_total_real_in", ["f8582_f8582_net_in", "f8582_f8582_net_loss", "f8582_f8582_carryover",  ""])
set_edges("f8582_f8582_total_in", ["f8582_f8582_total_real_in", "f8582_f8582_commercial_revitalization", "f8582_f8582_passive_activities",  ""])
set_edges("f8582_f8582_min", ["f8582_f8582_total_real_in", "f8582_f8582_total_in",  ""])
set_edges("f8582_magi", ["f1040_MAGI",  ""])
set_edges("f8582_f8582_half", ["f8582_magi",  ""])
set_edges("f8582_allowed_real_losses", ["f8582_f8582_min", "f8582_f8582_half",  ""])
set_edges("f8582_carryover_to_next_year", ["f8582_f8582_total_real_in", "f8582_allowed_real_losses",  ""])
set_edges("f8582_total_losses_8582", ["f8582_allowed_real_losses", "f8582_total_gains_8582",  ""])
set_edges("f6251_taxable_income", ["f1040_taxable_income",  ""])
set_edges("f6251_taxes_deducted", ["f1040_sched_a_total_itemized_deductions", "f1040_sched_a_total_taxes_deducted", "f1040_std_deduction",  ""])
set_edges("f6251_amt_refund_deduction", ["f1040sch1_taxable_tax_refunds",  ""])
set_edges("f6251_amt_income", ["f6251_taxable_income", "f6251_taxes_deducted", "f6251_amt_refund_deduction", "f6251_amt_investment_expense_deduction", "f6251_amt_depletion_deduction", "f6251_nold", "f6251_amt_nold",  ""])
set_edges("f6251_amt_exemption", ["f6251_amt_income",  ""])
set_edges("f6251_amt_in_minus_exemption", ["f6251_amt_income", "f6251_amt_exemption",  ""])
set_edges("f6251_amt_preftc", ["f6251_amt_in_minus_exemption",  ""])
set_edges("f6251_amt_tentative", ["f6251_amt_preftc", "f6251_amt_ftc",  ""])
set_edges("f6251_tax_from_1040", ["f1040_tax", "f1040sch2_credit_repayment", "f1040sch3_ftc",  ""])
set_edges("f6251_amt", ["f6251_amt_tentative", "f6251_tax_from_1040",  ""])
set_edges("f8863_scaled_education_expenses_1", ["f8863_education_expenses_1",  ""])
set_edges("f8863_rescaled_education_expenses_1", ["f8863_education_expenses_1", "f8863_education_expenses_1", "f8863_scaled_education_expenses_1",  ""])
set_edges("f8863_scaled_education_expenses_2", ["f8863_education_expenses_2",  ""])
set_edges("f8863_rescaled_education_expenses_2", ["f8863_education_expenses_2", "f8863_education_expenses_2", "f8863_scaled_education_expenses_2",  ""])
set_edges("f8863_scaled_education_expenses_3", ["f8863_education_expenses_3",  ""])
set_edges("f8863_rescaled_education_expenses_3", ["f8863_education_expenses_3", "f8863_education_expenses_3", "f8863_scaled_education_expenses_3",  ""])
set_edges("f8863_total_limited_expenses", ["f8863_rescaled_education_expenses_1", "f8863_rescaled_education_expenses_2", "f8863_rescaled_education_expenses_3",  ""])
set_edges("f8863_ninety_k_minus_agi", ["f8863_baseline", "f1040_AGI",  ""])
set_edges("f8863_fraction", ["f8863_ninety_k_minus_agi",  ""])
set_edges("f8863_unscaled_credit", ["f8863_total_limited_expenses", "f8863_fraction",  ""])
set_edges("f8863_refundable_credit", ["f8863_under_24", "f8863_unscaled_credit",  ""])
set_edges("f8863_remaining_credit", ["f8863_unscaled_credit", "f8863_refundable_credit",  ""])
set_edges("f8863_aqe", ["f8863_adjusted_qualified_expenses",  ""])
set_edges("f8863_sixty_seven_k_less_agi", ["f8863_baseline2", "f1040_AGI",  ""])
set_edges("f8863_fraction2", ["f8863_sixty_seven_k_less_agi",  ""])
set_edges("f8863_frac_allowed", ["f8863_fraction2", "f8863_aqe",  ""])
set_edges("f8863_nonrefundable_credit", ["f8863ws_limited_credit",  ""])
set_edges("f8863ws_credit_sum", ["f8863_remaining_credit", "f8863_frac_allowed",  ""])
set_edges("f8863ws_tax", ["f1040_tax",  ""])
set_edges("f8863ws_other_credits", ["f1040sch3_ftc", "f1040sch3_child_care",  ""])
set_edges("f8863ws_diff", ["f8863ws_tax", "f8863ws_other_credits",  ""])
set_edges("f8863ws_limited_credit", ["f8863ws_diff", "f8863ws_credit_sum",  ""])


}

reedge();

g.graph().rankdir="lr";

// Create the renderer
var render = new dagreD3.render();

// Set up an SVG group so that we can translate the final graph.
var svg = d3.select("svg"),
    svgGroup = svg.append("g");

// Run the renderer. This is what draws the final graph.
render(d3.select("svg g"), g);

// Center the graph
    svg.attr("width", g.graph().width + 40);
    svg.attr("height", g.graph().height + 40);
var xCenterOffset = (svg.attr("width") - g.graph().width) / 2;
svgGroup.attr("transform", "translate(" + xCenterOffset + ", 20)");


var val_prompt = function(d){
    //var promptval = window.prompt(this.textContent, g._nodes[d].val);
    var promptval = window.prompt(this.textContent);
    var floated = parseFloat(promptval)
    if(isNaN(floated)) return;
    g._nodes[d].val = floated;
    fixboxsize(g._nodes[d]);
    last_eval += 1;
    Cv("f1040_refund");
    Cv("f1040_tax_owed");
    Cv("f8582_carryover_to_next_year");
    redrawIt();
}

var redrawIt = function(){
    d3.selectAll("div.tooltip").style("opacity", 0);
    render(d3.select("svg g"), g);
    svg.attr("width", g.graph().width + 40);
    svg.attr("height", g.graph().height + 40);
    var xCenterOffset = (svg.attr("width") - g.graph().width) / 2;
    svgGroup.attr("transform", "translate(" + xCenterOffset + ", 20)");
    svg.selectAll(".u").on('click', val_prompt);

    var div = d3.select("body").append("div")
        .attr("class", "tooltip")
            .style("opacity", 0);

    svg.selectAll(".a_node")
        .on("mouseover", function(d) {
            div.transition()
                .duration(200)
                .style("opacity", .9);
            div .html(g._nodes[d].fullname + "<br>" + g._nodes[d].form)
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY - 28) + "px");
            }
            )
        .on("mouseout", function(d){
            div.transition()
                .duration(500)
                .style("opacity", 0);
                });
}


svg.selectAll(".u").on('click', val_prompt);

svg.selectAll("arrowhead").style("opacity", false);

var situations = [];

var last_eval = 0;

function Cv(name){
    this_cell = g._nodes[name];
    if (typeof this_cell === "undefined") this_cell = nodestorage[name];
    if (this_cell.eqn==="" || this_cell.last_eval >= last_eval)
        return parseFloat(this_cell.val);
    var out = parseFloat(eval(this_cell.eqn));

    if (g._nodes[name]){
        g._nodes[name].last_eval = last_eval;
        g._nodes[name].val = out;
        fixboxsize(g._nodes[name]);
    } else{
        nodestorage[name].last_eval = last_eval;
        nodestorage[name].val = out;
    }
    return out;
}

function recalc(){
    last_eval +=1
    Cv("f1040_refund");
    Cv("f1040_tax_owed");
    Cv("f8582_carryover_to_next_year");
    redrawIt();
}

function checkbox(id, checked){situations[id]=checked;
    if (!checked){
        svg.selectAll(id).each(function(i){
                if (g._nodes[i].class.match("critical")) return;
                var n = g._nodes[i];
                nodestorage[i] = { label: n.label,
                        baselabel: n.baselabel,
                        form: n.form,
                        fullname:  n.fullname,
                        class: n.class, val:n.val
                        , eqn: n.eqn, last_eval: n.last_eval
                        };
                g.removeNode(i);
            });
        redrawIt();
    } else {
        for (i in nodestorage){
            if (nodestorage[i].class.indexOf(id.replace('\.',''))>0){
                g.setNode(i, nodestorage[i], { label: nodestorage[i].label,
                        baselabel: nodestorage[i].baselabel,
                        form: nodestorage[i].form,
                        fullname:  nodestorage[i].fullname,
                        class: nodestorage[i].class, val:nodestorage[i].val
                        , eqn: nodestorage[i].eqn, last_eval: nodestorage[i].last_eval
                        });
            }
        }
        reedge();
        redrawIt();
    }
    Cv("f1040_refund");
    Cv("f1040_tax_owed");
}

function hidezeros(id, checked){
    if (!checked){
        checkbox(id, !checked);
    } else {
        for (i in g._nodes)  g._nodes[i].class.replace(/hide_zeros/g, "");
         for (i in nodestorage)  nodestorage[i].class.replace(/hide_zeros/g, "");
        for (i in g._nodes) if (g._nodes[i].val==0) g._nodes[i].class += " hide_zeros";
        redrawIt();
        checkbox(id, !checked);
    }
}

var kidcalc = function(){
    var kids = parseFloat(document.getElementById("kids").value)
    if (isNaN(kids)) kids = 0;
    checkbox('.kids', (kids>0 ? true : false)); recalc();
}

document.getElementById(".have_rr").click()
document.getElementById(".s_loans").click()
document.getElementById(".mort").click()
document.getElementById(".itemizing").click()
document.getElementById(".over_65").click()
document.getElementById(".spouse_over_65").click()
//checkbox(".kids", false)
kidcalc()

redrawIt()

</script>
</body>
</html>
